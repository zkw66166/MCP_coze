# 财务数据查询系统 - 搜索机制详解

> 本文档面向希望了解财务数据查询系统内部工作原理的技术人员和管理员。

---

## 一、系统概述

财务数据查询系统基于 `financial.db` 数据库，支持：

- 企业选择（前端下拉列表）
- 时间范围智能提取
- 指标名称模糊匹配
- Text-to-SQL自动生成查询
- 配置热更新

---

## 二、查询流程（四步策略）

```
用户问题: "2024年华府公司营业收入是多少"
       ↓
┌──────────────────────────┐
│ 步骤1: 企业识别           │  ← 从前端选择或问题中提取企业ID
└──────────────────────────┘
       ↓
┌──────────────────────────┐
│ 步骤2: 时间范围提取        │  ← 支持年份、季度、月份、时间段
└──────────────────────────┘
       ↓
┌──────────────────────────┐
│ 步骤3: 指标识别           │  ← 从配置文件匹配中文别名
└──────────────────────────┘
       ↓
┌──────────────────────────┐
│ 步骤4: 执行查询           │  ← Text-to-SQL 或 直接查询
└──────────────────────────┘
```

### 2.1 企业识别

> **注意**：当前版本通过前端下拉列表选择企业，确保企业名称唯一性。
> 企业别名表 `company_aliases` 为历史遗留，可不再维护。

企业识别顺序：

1. 前端传入的 `company_id`（最优先）
2. 从问题中匹配企业全名
3. 从问题中匹配企业简称（去掉"公司"等后缀）
4. 使用大模型智能识别（回退策略）

### 2.2 时间范围提取

系统支持多种时间表述方式：

| 表述方式 | 示例 | 解析结果 |
|----------|------|----------|
| 单年份 | "2024年" | `years: [2024]` |
| 年份范围 | "2022-2024年" | `years: [2022, 2023, 2024]` |
| 两位数年份 | "22-25年" | `years: [2022, 2023, 2024, 2025]` |
| 单季度 | "一季度"、"Q1" | `quarter: 1` |
| 多季度 | "Q1、Q2" | `quarters: [1, 2]` |
| 全年 | "全年"、"年度" | `is_full_year: true` |

**对比分析检测**：
当问题包含"增长"、"对比"、"趋势"等关键词时，自动标记为对比分析模式。

### 2.3 指标识别

系统从 `config/metrics_config.json` 加载指标别名映射：

```
用户输入: "营业收入"
      ↓
  配置查找: {"营业收入": ["total_revenue", "income_statements"]}
      ↓
  数据库字段: income_statements.total_revenue
```

**匹配优先级**：按关键词长度降序匹配，避免"所得税"误匹配到"企业所得税"。

### 2.4 执行查询

采用 **Text-to-SQL** 策略：

1. 将用户问题 + 企业ID + 时间范围发送给大模型
2. 大模型生成 SQL 查询语句
3. 执行 SQL 并验证结果
4. 格式化返回

---

## 三、配置文件结构

### 3.1 metrics_config.json

主配置文件，包含：

| 节点 | 用途 |
|------|------|
| `tables` | 各数据表的字段别名配置 |
| `formulas` | 计算指标公式定义 |
| `item_queries` | 特殊查询（key-value结构表） |
| `query_settings` | 查询逻辑配置（关键词列表等） |

**示例：字段配置**

```json
{
  "tables": {
    "income_statements": {
      "description": "利润表",
      "fields": {
        "total_revenue": {
          "aliases": ["营业收入", "收入", "营收"],
          "unit": "元",
          "category": "收入"
        }
      }
    }
  }
}
```

**示例：公式配置**

```json
{
  "formulas": {
    "毛利率": {
      "expression": "(total_revenue - cost_of_sales) / total_revenue * 100",
      "source_table": "income_statements",
      "unit": "%",
      "precomputed": "gross_margin_rate"
    }
  }
}
```

### 3.2 query_settings

查询逻辑相关配置（从代码提取，支持热更新）：

```json
{
  "query_settings": {
    "all_periods_keywords": ["多少", "数据", "金额", "查询", ...],
    "comparison_keywords": ["增长", "对比", "比较", "趋势", ...],
    "aggregation_tables": ["income_statements", "tax_reports", ...]
  }
}
```

---

## 四、热更新机制

系统支持配置文件热更新，无需重启服务：

1. 每次查询时，`MetricsLoader` 检查配置文件修改时间
2. 如果文件已变化，自动重新加载
3. 清除相关缓存（metrics_map、keywords、formulas）

**修改配置后**：保存 → 下次查询自动生效

---

## 五、示例

### 示例1：单指标查询

**问题**: "2024年华府公司营业收入是多少"

**解析结果**:

- 企业: 华府公司 (ID: 1)
- 时间: 2024年
- 指标: 营业收入 → income_statements.total_revenue

**生成SQL**:

```sql
SELECT period_year, period_quarter, total_revenue
FROM income_statements
WHERE company_id = 1 AND period_year = 2024
ORDER BY period_quarter
```

### 示例2：多年对比

**问题**: "2022-2024年净利润趋势"

**解析结果**:

- 时间: [2022, 2023, 2024]
- 指标: 净利润 → income_statements.net_profit
- 对比分析: true

**返回**: 各年度各季度净利润数据，支持趋势图表展示

---

## 六、维护脚本

### 6.1 配置更新脚本

```bash
python tools/update_financial_config.py
```

功能：

- 扫描数据库发现未配置别名的新字段
- 使用大模型建议中文别名
- 生成更新报告

### 6.2 测试脚本

```bash
python test_financial_query.py
```

验证：

- 热更新功能
- 时间范围提取
- 关键词配置使用
- 指标提取功能

---

*本文档旨在帮助技术人员理解财务查询系统的内部机制，便于系统维护和问题排查。*
