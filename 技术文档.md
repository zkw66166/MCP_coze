# MCP_coze 智能财税对话系统 - 技术文档

> **版本**: v1.0  
> **更新日期**: 2026-01-10  
> **作者**: AI Assistant

---

## 目录

1. [项目概述](#1-项目概述)
2. [系统架构](#2-系统架构)
3. [技术栈](#3-技术栈)
4. [目录结构](#4-目录结构)
5. [核心模块详解](#5-核心模块详解)
6. [数据库设计](#6-数据库设计)
7. [智能路由机制](#7-智能路由机制)
8. [关键功能实现](#8-关键功能实现)
9. [API接口说明](#9-api接口说明)
10. [部署与运行](#10-部署与运行)
11. [调试踩坑与避坑指南](#11-调试踩坑与避坑指南)
12. [未来优化方向](#12-未来优化方向)

---

## 1. 项目概述

### 1.1 项目背景

MCP_coze 是一个基于 PyQt6 的智能财税对话系统,集成了:

- **本地财务数据库查询** (SQLite)
- **本地税收优惠政策库查询** (SQLite)
- **扣子(Coze)智能体对话** (外部API)
- **DeepSeek大模型** (用于智能提取和归纳)

### 1.2 核心功能

| 功能 | 描述 |
|------|------|
| 财务数据查询 | 支持多时间段对比分析、趋势分析、动态指标计算 |
| 税收优惠查询 | 结构化搜索税种、优惠项目、认定条件 |
| 智能路由 | 自动识别用户意图,路由到最佳数据源 |
| 图表生成 | 自动生成柱状图、折线图进行数据可视化 |
| PDF导出 | 导出完整对话记录(含图表)为PDF |
| 历史持久化 | 自动保存对话历史,支持删除确认和导航 |

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      PyQt6 GUI Layer                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │ InputWidget  │  │ ChatWidget   │  │ MainWindow       │  │
│  │ (问题输入)    │  │ (对话显示)   │  │ (工具栏/状态栏)  │  │
│  └──────────────┘  └──────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   RoutedChatThread (核心路由线程)            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              IntentClassifier (意图识别)              │  │
│  │  financial_data │ tax_incentive │ other (知识库)      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
          │                    │                    │
          ▼                    ▼                    ▼
┌────────────────┐  ┌────────────────┐  ┌────────────────────┐
│ FinancialQuery │  │ TaxIncentive   │  │   Coze API         │
│ (财务数据查询)  │  │ Query(税收查询) │  │  (扣子智能体)       │
│ + DeepSeek归纳 │  │ + DeepSeek归纳 │  │                    │
└────────────────┘  └────────────────┘  └────────────────────┘
          │                    │
          ▼                    ▼
┌────────────────┐  ┌────────────────┐
│ financial.db   │  │tax_incentives  │
│ (财务数据库)    │  │.db (政策库)    │
└────────────────┘  └────────────────┘
```

---

## 3. 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| GUI框架 | PyQt6 | 6.10.1 |
| 数据库 | SQLite3 | 内置 |
| 图表生成 | Matplotlib | 3.9.4 |
| Markdown渲染 | markdown2 | 2.5.4 |
| HTTP请求 | requests | 2.32.5 |
| PDF导出 | PyQt6 QPrinter | 原生 |
| 大模型API | DeepSeek | - |
| 智能体API | 扣子(Coze) | - |

---

## 4. 目录结构

```
MCP_coze/
├── coze_chat.py              # 主程序入口 (GUI + 路由逻辑)
├── coze_chat.bat             # Windows启动脚本
├── requirements.txt          # 依赖列表
│
├── modules/                  # 核心模块
│   ├── __init__.py
│   ├── intent_classifier.py  # 意图识别器
│   ├── db_query.py           # 税收优惠查询
│   ├── financial_query.py    # 财务数据查询
│   ├── chart_widget.py       # 图表生成器
│   └── deepseek_client.py    # DeepSeek API客户端
│
├── database/                 # 数据库
│   ├── financial.db          # 财务数据库
│   ├── tax_incentives.db     # 税收优惠政策库
│   ├── init_db.py            # 数据库初始化脚本
│   ├── calculate_metrics.py  # 指标计算脚本
│   └── update_financial_data.py  # 数据补全脚本
│
├── data/                     # 运行时数据
│   └── chat_history.json     # 对话历史持久化
│
├── data_source/              # 原始数据源
│   └── *.xlsx                # Excel数据文件
│
└── venv/                     # Python虚拟环境
```

---

## 5. 核心模块详解

### 5.1 coze_chat.py (主程序)

**职责**: GUI界面、线程管理、路由调度

**核心类**:

| 类名 | 职责 |
|------|------|
| `ChatThread` | Coze API对话线程 |
| `RoutedChatThread` | 智能路由对话线程 (核心) |
| `ChatWidget` | 对话显示区域 |
| `InputWidget` | 输入区域 + 历史记录 |
| `MainWindow` | 主窗口 + 工具栏 |

**关键方法**:

```python
class RoutedChatThread(QThread):
    def run(self):
        # 1. 意图识别
        intent = self.classifier.classify(question)
        
        # 2. 路由到对应处理器
        if intent == 'financial_data':
            self._query_financial_database()
        elif intent == 'tax_incentive':
            self._query_local_database()
        else:
            self._query_coze_api()
```

### 5.2 intent_classifier.py (意图识别)

**职责**: 分析用户问题,判断查询类型

**识别逻辑优先级**:

1. **知识库优先关键词** (申报、办理、注册等) → `other`
2. **财务数据关键词** (利润、收入、资产等) → `financial_data`
3. **税收优惠关键词** (优惠、减免、加计扣除等) → `tax_incentive`
4. **默认** → `other` (路由到Coze)

```python
class IntentClassifier:
    knowledge_base_priority_keywords = [
        "指南", "申报", "申请", "办理", "注册", ...
    ]
    financial_keywords = ["利润", "收入", "资产", "负债", ...]
    tax_keywords = ["优惠", "减免", "免税", "退税", ...]
```

### 5.3 financial_query.py (财务查询)

**职责**: 财务数据查询、公式计算、多时间段对比

**核心功能**:

| 方法 | 功能 |
|------|------|
| `extract_metric()` | 从问题中提取财务指标 |
| `extract_time_range()` | 提取时间范围(支持多年/多季度) |
| `query()` | 执行查询 |
| `calculate_comparison()` | 计算增长率、变化额 |
| `format_comparison()` | 格式化对比结果 |

**指标体系**:

```python
METRIC_MAPPING = {
    "利润": {"table": "profit_loss", "field": "profit"},
    "毛利率": {"formula": "(total_revenue - cost_of_sales) / total_revenue * 100"},
    "资产负债率": {"formula": "total_liabilities / total_assets * 100"},
    ...
}
```

### 5.4 db_query.py (税收优惠查询)

**职责**: 税收优惠政策结构化搜索

**核心功能**:

| 方法 | 功能 |
|------|------|
| `extract_tax_project_keywords()` | 使用DeepSeek提取关键词 |
| `structured_search()` | 结构化SQL查询 |
| `count_structured_results()` | 统计查询结果数 |

### 5.5 chart_widget.py (图表生成)

**职责**: 使用Matplotlib生成财务图表

**支持图表类型**:

- 柱状图 (多时间段对比)
- 折线图 (趋势分析)
- 对比图表 (带增长率标注)

```python
class FinancialChartGenerator:
    def generate_bar_chart(results, title) -> str  # 返回Base64图片
    def generate_line_chart(results, title) -> str
    def generate_comparison_chart(comparison_result, company_name) -> str
```

---

## 6. 数据库设计

### 6.1 financial.db (财务数据库)

**表结构**:

```sql
-- 公司表
CREATE TABLE companies (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL
);

-- 利润表
CREATE TABLE profit_loss (
    id INTEGER PRIMARY KEY,
    company_id INTEGER,
    period_year INTEGER,
    period_quarter INTEGER,
    operating_revenue REAL,      -- 营业收入
    non_operating_income REAL,   -- 营业外收入
    total_revenue REAL,          -- 收入合计
    operating_costs REAL,        -- 营业成本
    non_operating_expenses REAL, -- 营业外支出
    cost_of_sales REAL,          -- 销售成本合计
    gross_profit REAL,           -- 毛利润
    profit REAL                  -- 净利润
);

-- 资产负债表
CREATE TABLE balance_sheet (
    company_id INTEGER,
    period_year INTEGER,
    period_quarter INTEGER,
    total_assets REAL,
    total_liabilities REAL,
    owners_equity REAL,
    ...
);
```

### 6.2 tax_incentives.db (税收优惠政策库)

**表结构**:

```sql
CREATE TABLE tax_incentives (
    id INTEGER PRIMARY KEY,
    tax_type TEXT,           -- 税种 (增值税/企业所得税/...)
    project_name TEXT,       -- 优惠项目名称
    incentive_method TEXT,   -- 优惠方式 (免税/减征/加计扣除/...)
    qualification TEXT,      -- 认定条件
    detailed_rules TEXT      -- 具体规定
);
```

---

## 7. 智能路由机制

### 7.1 路由流程

```
用户输入问题
      │
      ▼
┌─────────────────────────────────────┐
│ IntentClassifier.classify(question) │
└─────────────────────────────────────┘
      │
      ├──[知识库优先关键词]──→ other (Coze API)
      │
      ├──[财务数据关键词]────→ financial_data
      │                         │
      │                         ▼
      │                    FinancialQuery
      │                         │
      │                         ▼
      │                    DeepSeek归纳
      │
      ├──[税收优惠关键词]────→ tax_incentive
      │                         │
      │                         ▼
      │                    TaxIncentiveQuery
      │                         │
      │                         ▼
      │                    DeepSeek归纳
      │
      └──[其他]──────────────→ other (Coze API)
```

### 7.2 知识库优先规则

某些关键词即使包含财务/税收词汇,也应路由到知识库:

```python
# 例如: "如何申报企业所得税?"
# 包含"企业所得税"但因为有"申报",优先路由到知识库
knowledge_base_priority_keywords = [
    "指南", "申报", "申请", "办理", "注册", "认定", ...
]
```

---

## 8. 关键功能实现

### 8.1 多时间段对比分析

**支持格式**:

- 多年: `2023年和2024年利润对比`
- 年份范围: `2022-2024年收入趋势`
- 多季度: `2023年1、2、3季度`

**实现关键**:

```python
def extract_time_range(question):
    # 提取年份列表
    years = []
    # 匹配: 2023年和2024年
    # 匹配: 2022-2024年
    # 匹配: 2023、2024年
    
    result['is_comparison'] = len(years) > 1
    result['years'] = years
    return result
```

### 8.2 图表生成与嵌入

```python
# 生成Base64编码图片
chart_base64 = chart_gen.generate_bar_chart(results, company_name)

# 嵌入HTML
chart_html = f'<img src="{chart_base64}" style="max-width:100%">'
self.content_received.emit(chart_html)
```

### 8.3 PDF导出

```python
def _export_to_pdf(self):
    printer = QPrinter(QPrinter.PrinterMode.ScreenResolution)
    printer.setOutputFormat(QPrinter.OutputFormat.PdfFormat)
    printer.setOutputFileName(file_path)
    printer.setResolution(96)  # 屏幕DPI
    
    self.chat_w.chat_display.print(printer)
```

### 8.4 历史记录持久化

```python
HISTORY_FILE = "data/chat_history.json"

def _save_history(self):
    history = [{"question": item.text()} for item in self.history_list]
    with open(HISTORY_FILE, 'w', encoding='utf-8') as f:
        json.dump(history, f, ensure_ascii=False)

def _load_history(self):
    if os.path.exists(HISTORY_FILE):
        with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
            history = json.load(f)
```

---

## 9. API接口说明

### 9.1 Coze API

```python
API_URL = "https://api.coze.cn/v3/chat"
HEADERS = {
    "Authorization": f"Bearer {PAT_TOKEN}",
    "Content-Type": "application/json"
}

payload = {
    "bot_id": BOT_ID,
    "user_id": "user_xxx",
    "stream": True,
    "additional_messages": [{"role": "user", "content": question}]
}
```

### 9.2 DeepSeek API

```python
API_URL = "https://api.deepseek.com/chat/completions"
HEADERS = {
    "Authorization": f"Bearer {API_KEY}",
    "Content-Type": "application/json"
}

payload = {
    "model": "deepseek-chat",
    "messages": [{"role": "user", "content": prompt}],
    "stream": True
}
```

---

## 10. 部署与运行

### 10.1 环境准备

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境 (Windows)
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 10.2 依赖列表 (requirements.txt)

```
PyQt6==6.10.1
PyQt6-Qt6==6.10.1
PyQt6_sip==13.10.2
requests==2.32.5
markdown2==2.5.4
matplotlib==3.9.4
pandas==1.5.3
numpy==1.23.5
```

### 10.3 运行程序

```bash
# 方式1: 直接运行
python coze_chat.py

# 方式2: 使用批处理
coze_chat.bat
```

---

## 11. 调试踩坑与避坑指南

### 11.1 虚拟环境路径问题

**问题**: pip安装到错误的venv目录

**现象**:

```
pip list 显示已安装
python -c "import xxx" 报 ModuleNotFoundError
```

**原因**: pip.exe和python.exe指向不同的venv

**解决方案**:

```bash
# 使用完整路径确保一致
D:\MyProjects\MCP_coze\venv\Scripts\python.exe -m pip install xxx
```

> ⚠️ **避坑指南**: 始终使用 `python -m pip` 而非直接调用 `pip`

---

### 11.2 PDF中文乱码

**问题**: 使用xhtml2pdf导出PDF显示乱码

**现象**: 中文显示为方块或乱码

**原因**: xhtml2pdf默认不支持中文字体,注册字体方式复杂

**解决方案**: 改用Qt原生打印

```python
# ❌ 错误做法
from xhtml2pdf import pisa
pisa.CreatePDF(html, dest=pdf_file)

# ✅ 正确做法
from PyQt6.QtPrintSupport import QPrinter
printer = QPrinter(QPrinter.PrinterMode.ScreenResolution)
self.chat_w.chat_display.print(printer)
```

> ⚠️ **避坑指南**: PyQt6应用优先使用Qt原生功能,而非第三方PDF库

---

### 11.3 PDF比例失调

**问题**: PDF中文字极小,图片极大

**现象**: HighResolution模式下比例不正常

**解决方案**:

```python
# ❌ 错误做法
printer = QPrinter(QPrinter.PrinterMode.HighResolution)

# ✅ 正确做法
printer = QPrinter(QPrinter.PrinterMode.ScreenResolution)
printer.setResolution(96)  # 屏幕DPI
```

---

### 11.4 PyQt6 API变化

**问题**: `print_` 方法不存在

**现象**: `'QTextBrowser' object has no attribute 'print_'`

**原因**: PyQt6中方法名是 `print` 不是 `print_`

```python
# PyQt5
doc.print_(printer)

# PyQt6
doc.print(printer)
```

> ⚠️ **避坑指南**: PyQt5到PyQt6有API名称变化,注意查阅文档

---

### 11.5 图表尺寸不适合PDF

**问题**: 图表在PDF中被截断

**解决方案**: 调整matplotlib图表尺寸

```python
# ❌ 太大
self.figure_size = (8, 4)

# ✅ 适合A4
self.figure_size = (6, 3.5)
```

---

### 11.6 QTextEdit Placeholder不换行

**问题**: placeholder文字不支持多行显示

**解决方案**: 使用简短的单行提示,在标题中补充说明

```python
# ❌ 多行不显示
self.input_field.setPlaceholderText("第一行\n第二行")

# ✅ 单行 + 标题补充
title = QLabel("📝 输入问题 (财务/税收/通用)")
self.input_field.setPlaceholderText("如: 2023年利润率?")
```

---

### 11.7 SQLite查询结果为空

**问题**: 财务查询返回空结果

**排查步骤**:

1. 检查数据库是否有数据
2. 检查公司ID是否正确
3. 检查时间范围是否有数据
4. 检查字段是否为NULL

**调试工具**:

```python
# check_financial_db.py
cursor.execute("SELECT * FROM profit_loss LIMIT 5")
print(cursor.fetchall())
```

---

### 11.8 意图识别错误路由

**问题**: "如何申报企业所得税" 被路由到税收优惠查询

**原因**: 包含"企业所得税"关键词

**解决方案**: 添加知识库优先关键词

```python
knowledge_base_priority_keywords = [
    "申报", "申请", "办理", "如何", "怎么", ...
]

# 优先检查知识库关键词
if self._should_route_to_knowledge_base(question):
    return 'other'
```

---

## 12. 未来优化方向

### 12.1 功能优化

- [ ] 支持更多财务指标和公式
- [ ] 添加现金流量表查询
- [ ] 支持自定义时间范围对比
- [ ] 增加数据导出为Excel功能

### 12.2 性能优化

- [ ] 数据库查询缓存
- [ ] 图表异步生成
- [ ] 大模型响应流式优化

### 12.3 用户体验

- [ ] 添加暗色主题
- [ ] 支持对话导出为Word
- [ ] 添加语音输入功能
- [ ] 移动端适配

---

## 附录: 常用调试命令

```bash
# 检查数据库
python check_financial_db.py
python check_db.py

# 测试意图识别
python test_intent.py

# 测试财务查询
python test_query.py

# 测试多时间对比
python test_comparison.py

# 运行主程序
python coze_chat.py
```

---

*文档结束*
