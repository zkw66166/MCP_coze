/**
 * API 服务 - 与 FastAPI 后端通信
 */

// API 基础 URL（开发环境使用 Vite 代理，生产环境使用相对路径）
const API_BASE_URL = '';

/**
 * 获取企业列表
 */
export async function fetchCompanies() {
    const response = await fetch(`${API_BASE_URL}/api/companies`);
    if (!response.ok) {
        throw new Error(`获取企业列表失败: ${response.status}`);
    }
    return response.json();
}

/**
 * 获取统计信息
 */
export async function fetchStatistics() {
    const response = await fetch(`${API_BASE_URL}/api/statistics`);
    if (!response.ok) {
        throw new Error(`获取统计信息失败: ${response.status}`);
    }
    return response.json();
}

/**
 * 流式聊天 API
 * @param {string} question 用户问题
 * @param {number|null} companyId 企业 ID（可选）
 * @param {boolean} showChart 是否显示图表
 * @param {function} onMessage 收到消息回调
 * @param {function} onRoute 路由事件回调
 * @param {function} onChart 图表数据回调
 * @param {function} onSummary 分析总结回调（新增）
 * @param {function} onError 错误回调
 * @param {function} onDone 完成回调
 * @returns {AbortController} 用于取消请求
 */
export function streamChat(question, companyId, showChart, { onMessage, onRoute, onChart, onSummary, onError, onDone }) {
    const controller = new AbortController();

    const fetchData = async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/api/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question,
                    company_id: companyId,
                    enable_routing: true,
                    show_chart: showChart
                }),
                signal: controller.signal
            });

            if (!response.ok) {
                throw new Error(`API 错误: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let currentEvent = '';

            while (true) {
                const { done, value } = await reader.read();

                if (done) {
                    break;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('event: ')) {
                        currentEvent = line.slice(7).trim();
                        continue;
                    }

                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));

                            // 根据事件类型处理
                            if (currentEvent === 'chart') {
                                onChart?.(data);
                            } else if (currentEvent === 'summary') {
                                // 分析总结（渲染在图表之后）
                                onSummary?.(data.content);
                            } else if (data.content !== undefined) {
                                onMessage?.(data.content);
                            }

                            if (data.path !== undefined) {
                                onRoute?.(data.path, data.company);
                            }

                            if (data.status === 'completed') {
                                onDone?.();
                            }

                            if (data.message !== undefined && currentEvent === 'error') {
                                onError?.(data.message);
                            }
                        } catch (e) {
                            // 忽略解析错误
                        }
                    }
                }
            }

            onDone?.();
        } catch (error) {
            if (error.name !== 'AbortError') {
                onError?.(error.message);
            }
        }
    };

    fetchData();

    return controller;
}

/**
 * 健康检查
 */
export async function healthCheck() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/health`);
        return response.ok;
    } catch {
        return false;
    }
}
